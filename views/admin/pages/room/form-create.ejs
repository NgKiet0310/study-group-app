
<% layout('layouts/main-admin') %>

<div class="container mt-5">
  <div class="card shadow-lg rounded-4 border-0">
    <div class="card-header bg-gradient-primary text-white fw-bold fs-4 p-4">
      <i class="bi bi-door-open-fill me-2"></i> Tạo phòng mới
    </div>
    <div class="card-body p-4">
      <!-- Hiển thị thông báo lỗi -->
      <% if (typeof error !== 'undefined' && error) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <%= error %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>

      <!-- Hiển thị thông báo thành công -->
      <% if (typeof success !== 'undefined' && success) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <%= success %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>

      <form action="/admin/room/create" method="POST" id="create-room-form">
        <div class="row mb-4">
          <div class="col-md-6">
            <label for="name" class="form-label fw-semibold">Tên phòng <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text bg-light"><i class="bi bi-house-fill"></i></span>
              <input type="text" name="name" id="name" class="form-control rounded-end" required maxlength="100" placeholder="Nhập tên phòng...">
            </div>
          </div>

          <div class="col-md-6">
            <label for="code" class="form-label fw-semibold">Mã phòng <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text bg-light"><i class="bi bi-key-fill"></i></span>
            <input type="text" name="code" id="code" class="form-control rounded-end" minlength="6" maxlength="50" placeholder="VD: room123...">
            </div>
          </div>
        </div>

        <div class="mb-4">
          <label for="description" class="form-label fw-semibold">Mô tả</label>
          <textarea name="description" id="description" class="form-control" maxlength="500" rows="4" placeholder="Thông tin mô tả về phòng..."></textarea>
        </div>

        <div class="mb-4">
          <label class="form-label fw-semibold">Thành viên thêm vào phòng</label>
          <div id="members-list">
            <!-- Dòng thành viên mẫu -->
            <div class="row g-2 mb-3 member-item align-items-center">
              <div class="col-md-6">
                <select name="members[0][user]" class="form-select" required>
                  <option value="">-- Chọn thành viên --</option>
                  <% users.forEach(user => { %>
                    <option value="<%= user._id %>"><%= user.username %></option>
                  <% }) %>
                </select>
              </div>
              <div class="col-md-4">
                <select name="members[0][role]" class="form-select">
                  <option value="member" selected>Member</option>
                  <option value="host">Host</option>
                </select>
              </div>
              <div class="col-md-2 d-grid">
                <button type="button" class="btn btn-danger btn-sm remove-member">
                  <i class="bi bi-x-lg"></i> Xóa
                </button>
              </div>
            </div>
          </div>

          <button type="button" id="add-member" class="btn btn-outline-primary btn-sm mt-2">
            <i class="bi bi-person-plus-fill me-1"></i> Thêm thành viên
          </button>
        </div>

        <div class="d-grid mt-4">
          <button type="submit" class="btn btn-primary btn-lg fw-bold bg-gradient-primary" id="submit-btn">
            <i class="bi bi-save me-2"></i> Tạo phòng
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  .bg-gradient-primary {
    background: linear-gradient(45deg, #007bff, #00c4ff);
  }
  .card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2) !important;
  }
  .form-control, .form-select {
    border-radius: 0.5rem;
    transition: border-color 0.3s ease;
  }
  .form-control:focus, .form-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }
  .btn-primary {
    border-radius: 0.5rem;
  }
  .btn-outline-primary:hover {
    background: linear-gradient(45deg, #007bff, #00c4ff);
    color: white;
  }
  .alert {
    border-radius: 0.5rem;
  }
</style>

<script>
  // Định nghĩa danh sách user để sử dụng trong JavaScript
  const usersOptions = `<% users.forEach(user => { %>
    <option value="<%= user._id %>"><%= user.username %></option>
  <% }) %>`;

  // Quản lý chỉ số thành viên
  let memberIndex = 1;

  // Thêm thành viên mới
  document.getElementById('add-member').addEventListener('click', () => {
    const list = document.getElementById('members-list');
    const div = document.createElement('div');
    div.className = 'row g-2 mb-3 member-item align-items-center';
    div.innerHTML = `
      <div class="col-md-6">
        <select name="members[${memberIndex}][user]" class="form-select" required>
          <option value="">-- Chọn thành viên --</option>
          ${usersOptions}
        </select>
      </div>
      <div class="col-md-4">
        <select name="members[${memberIndex}][role]" class="form-select">
          <option value="member" selected>Member</option>
          <option value="host">Host</option>
        </select>
      </div>
      <div class="col-md-2 d-grid">
        <button type="button" class="btn btn-danger btn-sm remove-member">
          <i class="bi bi-x-lg"></i> Xóa
        </button>
      </div>
    `;
    list.appendChild(div);
    memberIndex++;
  });

  // Xóa thành viên
  document.addEventListener('click', (e) => {
    if (e.target.closest('.remove-member')) {
      e.target.closest('.member-item').remove();
    }
  });

  // Hiệu ứng loading khi submit
  document.getElementById('create-room-form').addEventListener('submit', (e) => {
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.querySelector('.spinner-border').classList.remove('d-none');
    submitBtn.disabled = true;
  });
</script>